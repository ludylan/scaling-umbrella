<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Âè∞ÁÅ£Á©∫Ê∞£ÂìÅË≥™Âú∞Âúñ</title>
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.css"
    />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js"></script>
    <style>
      body {
        font-family: 'Microsoft JhengHei', sans-serif;
        margin: 0;
        padding: 0;
        background: #f5f5f5;
      }
      .top-container {
        display: flex;
        width: 100%;
        height: 40vh;
      }
      .left-panel {
        width: 75%;
        padding: 20px;
        box-sizing: border-box;
      }
      .right-panel {
        position: relative;
        width: 25%;
      }
      #map {
        position: absolute;
        top: 0;
        right: 0;
        width: 25vw;
        height: 40vh;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      }
      .info {
        margin-bottom: 20px;
      }
      h1 {
        margin: 0;
        font-size: 24px;
      }
      .selector, .update-time {
        margin: 10px 0;
      }
      .pointer-panel {
        position: relative;
        width: 200px;
        height: 200px;
        background: #fff;
        border-radius: 8px;
        padding: 10px;
        box-shadow: 0 0 8px rgba(0,0,0,0.2);
      }
      #pointerCanvas {
        width: 100%;
        height: 100%;
      }
      .station-info {
        font-size: 0.9em;
        color: #333;
        margin-top: 8px;
      }
      .bottom-container {
        width: 100%;
        height: 60vh;
        padding: 20px;
        box-sizing: border-box;
      }
      .chart-container {
        width: 100%;
        height: 100%;
        background: #fff;
        border-radius: 8px;
        padding: 15px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
      }
      #trendChart {
        width: 100%;
        height: 100%;
      }
      .map-controls {
        position: absolute;
        top: 10px;
        right: 10px;
        z-index: 1000;
      }
      .map-controls button {
        margin: 0 5px;
        padding: 5px 8px;
        border: none;
        background: #f0f0f0;
        border-radius: 4px;
        cursor: pointer;
      }
      .loading {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(255, 255, 255, 0.95);
        padding: 20px 30px;
        border-radius: 8px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        z-index: 1000;
      }
    </style>
  </head>
  <body>
    <div class="top-container">
      <div class="left-panel">
        <h1>üåè Âè∞ÁÅ£Á©∫Ê∞£ÂìÅË≥™Âú∞Âúñ</h1>
        <div class="update-time" id="lastUpdate"></div>
        <div class="selector">
          È°ØÁ§∫Ê±°ÊüìÁâ©Ôºö
          <select id="pollutantSelect">
            <option value="aqi">AQI</option>
            <option value="pm2.5">PM2.5</option>
            <option value="pm10">PM10</option>
            <option value="o3">O‚ÇÉ</option>
            <option value="co">CO</option>
            <option value="so2">SO‚ÇÇ</option>
            <option value="no2">NO‚ÇÇ</option>
          </select>
        </div>
        <div class="pointer-panel">
          <canvas id="pointerCanvas" width="200" height="200"></canvas>
          <div class="station-info" id="stationInfo"></div>
        </div>
      </div>
      <div class="right-panel">
        <div id="map"></div>
        <div class="map-controls">
          <button onclick="zoomIn()">+</button>
          <button onclick="zoomOut()">-</button>
        </div>
      </div>
    </div>
    <div class="bottom-container">
      <div class="chart-container">
        <canvas id="trendChart"></canvas>
      </div>
    </div>
    <div class="loading" id="loading">Ë≥áÊñôÊõ¥Êñ∞‰∏≠...</div>

    <script>
      const apiKey = 'a6528ecc-9e31-4e96-9f4a-8410d0c54436';
      // ‰ΩøÁî® CORS ‰ª£ÁêÜ
      const apiUrl = `https://cors-anywhere.herokuapp.com/https://data.moenv.gov.tw/api/v2/aqx_p_488?limit=1000&api_key=${apiKey}`;
      
      // Ê∑ªÂä†Ê∏¨Ë©¶Ë≥áÊñô
      const testData = [
        {
          "sitename": "Âè∞Âåó",
          "county": "Âè∞ÂåóÂ∏Ç",
          "aqi": "80",
          "pm2_5": "25",
          "pm10": "30",
          "o3": "45",
          "co": "0.5",
          "so2": "0.1",
          "no2": "15",
          "latitude": "25.0330",
          "longitude": "121.5654",
          "status": "ÊôÆÈÄö"
        },
        {
          "sitename": "Âè∞‰∏≠",
          "county": "Âè∞‰∏≠Â∏Ç",
          "aqi": "65",
          "pm2_5": "20",
          "pm10": "25",
          "o3": "40",
          "co": "0.4",
          "so2": "0.08",
          "no2": "12",
          "latitude": "24.1477",
          "longitude": "120.6736",
          "status": "ËâØÂ•Ω"
        }
      ];

      let currentData = null;
      let trendChart = null;
      let heatLayer = null;
      let lastFetchTime = 0;
      const CACHE_DURATION = 5 * 60 * 1000; // 5ÂàÜÈêòÂø´Âèñ

      const map = L.map('map').setView([23.7, 121], 7);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap'
      }).addTo(map);

      function zoomIn() { map.zoomIn(); }
      function zoomOut() { map.zoomOut(); }

      function updateLastUpdateTime() {
        const now = new Date();
        const timeString = now.toLocaleString('zh-TW', {
          year: 'numeric',
          month: '2-digit',
          day: '2-digit',
          hour: '2-digit',
          minute: '2-digit',
          second: '2-digit',
          hour12: false
        });
        document.getElementById('lastUpdate').innerText = `ÊúÄÂæåÊõ¥Êñ∞ÊôÇÈñìÔºö${timeString}`;
      }

      function toggleLoading(show) {
        document.getElementById('loading').style.display = show ? 'block' : 'none';
      }

      function getCachedData() {
        const cached = localStorage.getItem('airQualityData');
        if (!cached) return null;
        
        const { data, timestamp } = JSON.parse(cached);
        if (Date.now() - timestamp > CACHE_DURATION) {
          localStorage.removeItem('airQualityData');
          return null;
        }
        return data;
      }

      function cacheData(data) {
        localStorage.setItem('airQualityData', JSON.stringify({
          data,
          timestamp: Date.now()
        }));
      }

      function drawPointer(level) {
        const canvas = document.getElementById("pointerCanvas");
        const ctx = canvas.getContext("2d");
        ctx.clearRect(0, 0, 200, 200);

        // Áπ™Ë£ΩÂü∫Á§éÂúìÂúà
        ctx.beginPath();
        ctx.arc(100, 100, 90, 0, 2 * Math.PI);
        ctx.strokeStyle = "#ccc";
        ctx.stroke();

        // Áπ™Ë£ΩÂàªÂ∫¶
        for (let i = 0; i < 10; i++) {
          let angle = (i * 36 - 90) * Math.PI / 180;
          ctx.beginPath();
          ctx.moveTo(100, 100);
          ctx.lineTo(100 + 80 * Math.cos(angle), 100 + 80 * Math.sin(angle));
          ctx.strokeStyle = i < level ? "red" : "#ccc";
          ctx.stroke();
        }

        // Áπ™Ë£ΩÊåáÈáù
        let angle = (level * 36 - 90) * Math.PI / 180;
        ctx.beginPath();
        ctx.moveTo(100, 100);
        ctx.lineTo(100 + 60 * Math.cos(angle), 100 + 60 * Math.sin(angle));
        ctx.strokeStyle = "black";
        ctx.lineWidth = 3;
        ctx.stroke();
      }

      function findNearestStation(latlng) {
        if (!currentData) return null;
        let nearest = null;
        let minDist = Infinity;
        for (const station of currentData) {
          const dist = L.latLng(latlng).distanceTo([station.latitude, station.longitude]);
          if (dist < minDist) {
            minDist = dist;
            nearest = station;
          }
        }
        return nearest;
      }

      function updateHeatLayer(data, pollutant) {
        if (heatLayer) {
          map.removeLayer(heatLayer);
        }
        
        const points = data.map(item => {
          const lat = parseFloat(item.latitude);
          const lon = parseFloat(item.longitude);
          const value = parseFloat(item[pollutant]);
          if (!lat || !lon || isNaN(value)) return null;
          
          const intensity = Math.min(value / 100, 1);
          return [lat, lon, intensity];
        }).filter(point => point !== null);

        if (typeof L.heatLayer === 'function') {
          heatLayer = L.heatLayer(points, {
            radius: 25,
            blur: 15,
            maxZoom: 10,
            gradient: {
              0.0: '#2E8B57',
              0.2: '#9ACD32',
              0.4: '#FFD700',
              0.6: '#FFA500',
              0.8: '#FF4500',
              1.0: '#8B008B'
            }
          }).addTo(map);
        } else {
          console.error('Leaflet.heat Êèí‰ª∂Êú™Ê≠£Á¢∫ËºâÂÖ•');
          points.forEach(point => {
            L.circleMarker([point[0], point[1]], {
              radius: 5,
              fillColor: getColor(point[2] * 100, pollutant),
              color: '#fff',
              weight: 1,
              opacity: 1,
              fillOpacity: 0.8
            }).addTo(map);
          });
        }
      }

      function updateTrendChart(data) {
        const ctx = document.getElementById('trendChart').getContext('2d');
        const pollutant = document.getElementById("pollutantSelect").value;
        
        if (trendChart) {
          trendChart.destroy();
        }

        // ÊåâÁ∏£Â∏ÇÂàÜÁµÑ‰∏¶Ë®àÁÆóÂπ≥ÂùáÂÄº
        const countyData = {};
        data.forEach(item => {
          const county = item.county;
          const value = parseFloat(item[pollutant]);
          if (!isNaN(value)) {
            if (!countyData[county]) {
              countyData[county] = {
                sum: 0,
                count: 0
              };
            }
            countyData[county].sum += value;
            countyData[county].count++;
          }
        });

        // Ë®àÁÆóÊØèÂÄãÁ∏£Â∏ÇÁöÑÂπ≥ÂùáÂÄº
        const counties = Object.keys(countyData);
        const averages = counties.map(county => 
          (countyData[county].sum / countyData[county].count).toFixed(1)
        );

        trendChart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: counties,
            datasets: [{
              label: `${pollutant.toUpperCase()} ÊøÉÂ∫¶Âπ≥ÂùáÂÄº`,
              data: averages,
              backgroundColor: averages.map(v => getColor(parseFloat(v), pollutant)),
              borderColor: '#333',
              borderWidth: 1,
              borderRadius: 5,
              hoverBackgroundColor: averages.map(v => getHoverColor(parseFloat(v), pollutant)),
              hoverBorderColor: '#000',
              hoverBorderWidth: 2
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            animation: {
              duration: 1000,
              easing: 'easeInOutQuart'
            },
            scales: {
              y: {
                beginAtZero: true,
                title: {
                  display: true,
                  text: 'ÊøÉÂ∫¶ÂÄº',
                  font: {
                    size: 14,
                    weight: 'bold'
                  }
                },
                grid: {
                  color: 'rgba(0,0,0,0.1)'
                }
              },
              x: {
                title: {
                  display: true,
                  text: 'Á∏£Â∏Ç',
                  font: {
                    size: 14,
                    weight: 'bold'
                  }
                },
                grid: {
                  display: false
                },
                ticks: {
                  maxRotation: 45,
                  minRotation: 45
                }
              }
            },
            plugins: {
              tooltip: {
                backgroundColor: 'rgba(0,0,0,0.8)',
                titleFont: {
                  size: 14,
                  weight: 'bold'
                },
                bodyFont: {
                  size: 12
                },
                padding: 10,
                cornerRadius: 5,
                callbacks: {
                  label: function(context) {
                    return `Âπ≥ÂùáÂÄº: ${context.raw}`;
                  }
                }
              },
              legend: {
                display: false
              }
            },
            barPercentage: 0.6,
            categoryPercentage: 0.8
          }
        });
      }

      function getColor(value, pollutant) {
        const scale = [
          { max: 12, color: '#2E8B57' },
          { max: 35, color: '#9ACD32' },
          { max: 54, color: '#FFD700' },
          { max: 150, color: '#FFA500' },
          { max: 250, color: '#FF4500' },
          { max: Infinity, color: '#8B008B' }
        ];

        for (let i = 0; i < scale.length; i++) {
          if (value <= scale[i].max) return scale[i].color;
        }
        return '#000';
      }

      function getHoverColor(value, pollutant) {
        const scale = [
          { max: 12, color: '#3DA56D' },
          { max: 35, color: '#B0E57C' },
          { max: 54, color: '#FFE44D' },
          { max: 150, color: '#FFB74D' },
          { max: 250, color: '#FF6B4D' },
          { max: Infinity, color: '#A64DA6' }
        ];

        for (let i = 0; i < scale.length; i++) {
          if (value <= scale[i].max) return scale[i].color;
        }
        return '#333';
      }

      async function fetchData() {
        try {
          const now = Date.now();
          if (now - lastFetchTime < 60000) {
            console.log('Ë´ãÊ±ÇÂ§™È†ªÁπÅÔºå‰ΩøÁî®Âø´ÂèñË≥áÊñô');
            return;
          }

          toggleLoading(true);
          console.log('ÈñãÂßãË´ãÊ±ÇË≥áÊñô...');
          
          const cachedData = getCachedData();
          if (cachedData) {
            console.log('‰ΩøÁî®Âø´ÂèñË≥áÊñô');
            currentData = cachedData;
            updateLastUpdateTime();
            updateHeatLayer(currentData, document.getElementById("pollutantSelect").value);
            updateTrendChart(currentData);
            toggleLoading(false);
            return;
          }

          try {
            const response = await fetch(apiUrl, {
              headers: {
                'X-Requested-With': 'XMLHttpRequest'
              }
            });
            
            if (!response.ok) {
              throw new Error(`API ÈåØË™§: ${response.status}`);
            }
            
            const json = await response.json();
            currentData = json.records;
          } catch (error) {
            console.warn('API Ë´ãÊ±ÇÂ§±ÊïóÔºå‰ΩøÁî®Ê∏¨Ë©¶Ë≥áÊñô:', error);
            currentData = testData;
          }
          
          cacheData(currentData);
          lastFetchTime = now;
          
          updateLastUpdateTime();
          updateHeatLayer(currentData, document.getElementById("pollutantSelect").value);
          updateTrendChart(currentData);
        } catch (error) {
          console.error('Ë≥áÊñôËôïÁêÜÂ§±Êïó:', error);
          alert(`Ë≥áÊñôËôïÁêÜÂ§±ÊïóÔºö${error.message}\n‰ΩøÁî®Ê∏¨Ë©¶Ë≥áÊñôÁπºÁ∫åÈ°ØÁ§∫`);
          currentData = testData;
          updateLastUpdateTime();
          updateHeatLayer(currentData, document.getElementById("pollutantSelect").value);
          updateTrendChart(currentData);
        } finally {
          toggleLoading(false);
        }
      }

      // ÂàùÂßãÂåñ
      fetchData();
      
      // Ë®≠ÂÆöÊØè5ÂàÜÈêòËá™ÂãïÊõ¥Êñ∞
      setInterval(fetchData, 5 * 60 * 1000);

      // Áõ£ËÅΩÊ±°ÊüìÁâ©ÈÅ∏ÊìáËÆäÂåñ
      document.getElementById("pollutantSelect").addEventListener("change", () => {
        if (currentData) {
          updateHeatLayer(currentData, document.getElementById("pollutantSelect").value);
          updateTrendChart(currentData);
        }
      });

      // ‰øÆÊîπÂú∞ÂúñÈªûÊìä‰∫ã‰ª∂ËôïÁêÜ
      map.on('click', function(e) {
        const nearestStation = findNearestStation(e.latlng);
        if (nearestStation) {
          const pollutant = document.getElementById("pollutantSelect").value;
          const value = parseFloat(nearestStation[pollutant]);
          
          // Ê†πÊìö‰∏çÂêåÊ±°ÊüìÁâ©Ë™øÊï¥ÊåáÈáùÁ≠âÁ¥öË®àÁÆó
          let level;
          if (pollutant === 'pm2.5' || pollutant === 'pm10') {
            level = Math.min(Math.floor(value / 10), 9) + 1;
          } else if (pollutant === 'aqi') {
            level = Math.min(Math.floor(value / 25), 9) + 1;
          } else {
            level = Math.min(Math.floor(value / 20), 9) + 1;
          }
          
          drawPointer(level);
          document.getElementById("stationInfo").innerHTML = `
            <strong>${nearestStation.sitename}</strong><br/>
            ${pollutant.toUpperCase()}Ôºö${value}<br/>
            ÁãÄÊÖãÔºö${nearestStation.status}
          `;
        }
      });
    </script>
  </body>
</html>
