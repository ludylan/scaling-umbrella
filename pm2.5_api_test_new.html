<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>空氣品質指標圖表</title>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script type="text/javascript">
      google.charts.load('current', { packages: ['corechart'] });
      google.charts.setOnLoadCallback(() => {
        fetchAQIData();
        setInterval(fetchAQIData, 3600000);
      });

      let allRecords = [];

      function fetchAQIData() {
        const apiKey = 'your-api-key'; // ← 請替換為你的 API 金鑰
        const apiUrl = `https://data.moenv.gov.tw/api/v2/aqx_p_488?limit=1000&api_key=${apiKey}`;

        fetch(apiUrl)
          .then((response) => response.json())
          .then((json) => {
            allRecords = json.records;
            populateCountyOptions(allRecords);
            updateChart();
            document.getElementById("update_time").textContent =
              "最後更新時間：" + new Date().toLocaleString();
          })
          .catch((error) => {
            console.error('資料擷取失敗:', error);
          });
      }

      function populateCountyOptions(records) {
        const countySet = new Set(records.map(r => r.county).filter(Boolean));
        const select = document.getElementById("county_select");
        select.innerHTML = '<option value="all">全部縣市</option>';
        [...countySet].sort().forEach(county => {
          const option = document.createElement("option");
          option.value = county;
          option.textContent = county;
          select.appendChild(option);
        });
      }

      function updateChart() {
        const selectedCounty = document.getElementById("county_select").value;
        const filtered = selectedCounty === 'all'
          ? allRecords
          : allRecords.filter(r => r.county === selectedCounty);
        const chartData = transformData(filtered);
        drawChart(chartData);
      }

      function transformData(records) {
        const dataArray = [
          [
            '測站名稱',
            '縣市',
            'AQI',
            '污染物',
            '狀態',
            'SO₂(ppb)',
            'CO(ppm)',
            'O₃(ppb)',
            'O₃_8hr(ppb)',
            'PM10(μg/m³)',
            'PM2.5(μg/m³)',
            'NO₂(ppb)',
            'NOx(ppb)',
            'NO(ppb)',
            '風速(m/s)',
            '風向(°)',
            '資料時間'
          ]
        ];

        records.forEach((r) => {
          dataArray.push([
            r.sitename,
            r.county,
            parseFloat(r.aqi),
            r.pollutant,
            r.status,
            parseFloat(r.so2),
            parseFloat(r.co),
            parseFloat(r.o3),
            parseFloat(r.o3_8hr),
            parseFloat(r.pm10),
            parseFloat(r.pm2_5),
            parseFloat(r.no2),
            parseFloat(r.nox),
            parseFloat(r.no),
            parseFloat(r.windspeed),
            parseFloat(r.winddirec),
            r.datacreationdate
          ]);
        });

        return dataArray;
      }

      function drawChart(chartData) {
        const data = google.visualization.arrayToDataTable(chartData);
        const options = {
          title: '空氣品質（以 AQI 為主）',
          hAxis: { title: '測站名稱' },
          vAxis: { title: 'AQI' },
          legend: 'none',
          height: 600,
        };

        const chart = new google.visualization.ColumnChart(
          document.getElementById('chart_div')
        );
        chart.draw(data, options);
      }
    </script>
  </head>
  <body>
    <h1>台灣空氣品質資訊展示</h1>
    <div id="update_time" style="margin-bottom: 10px; color: gray;"></div>

    <label for="county_select">選擇縣市：</label>
    <select id="county_select" onchange="updateChart()"></select>

    <div id="chart_div" style="width: 100%; height: 600px"></div>
  </body>
</html>
