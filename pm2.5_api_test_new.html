<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Âè∞ÁÅ£Á©∫Ê∞£ÂìÅË≥™Âú∞Âúñ</title>
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.css"
    />
    <style>
      #map {
        height: 70vh;
        width: 100%;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      }
      body {
        font-family: 'Microsoft JhengHei', sans-serif;
        margin: 0;
        padding: 20px;
        background-color: #f5f5f5;
      }
      .info {
        padding: 15px;
        background: #ffffff;
        border-radius: 8px;
        margin: 10px 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
      }
      .last-update {
        font-size: 0.9em;
        color: #666;
      }
      .loading {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(255, 255, 255, 0.95);
        padding: 20px 30px;
        border-radius: 8px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        z-index: 1000;
      }
      .chart-container {
        margin-top: 20px;
        padding: 15px;
        background: #ffffff;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
      }
      .map-controls {
        position: absolute;
        top: 10px;
        right: 10px;
        z-index: 1000;
        background: white;
        padding: 5px;
        border-radius: 4px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      }
      .map-controls button {
        margin: 5px;
        padding: 5px 10px;
        border: none;
        background: #f0f0f0;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.3s ease;
      }
      .map-controls button:hover {
        background: #e0e0e0;
        transform: scale(1.1);
      }
      .legend {
        position: absolute;
        bottom: 20px;
        right: 20px;
        z-index: 1000;
        background: white;
        padding: 10px;
        border-radius: 4px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      }
      .legend-item {
        display: flex;
        align-items: center;
        margin: 5px 0;
        transition: all 0.3s ease;
      }
      .legend-item:hover {
        transform: translateX(5px);
      }
      .legend-color {
        width: 20px;
        height: 20px;
        margin-right: 10px;
        border-radius: 50%;
        transition: all 0.3s ease;
      }
      .legend-item:hover .legend-color {
        transform: scale(1.2);
      }
      .marker-fade-in {
        animation: fadeIn 0.5s ease-in;
      }
      @keyframes fadeIn {
        from { opacity: 0; transform: scale(0.8); }
        to { opacity: 1; transform: scale(1); }
      }
    </style>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js"></script>
  </head>
  <body>
    <h2>üåè Âè∞ÁÅ£Á©∫Ê∞£ÂìÅË≥™Âú∞Âúñ</h2>
    <div class="info">
      <div>
        È°ØÁ§∫Ê±°ÊüìÁâ©Ôºö
        <select id="pollutantSelect">
          <option value="aqi">AQI</option>
          <option value="pm2_5">PM2.5</option>
          <option value="pm10">PM10</option>
          <option value="o3">O‚ÇÉ</option>
          <option value="co">CO</option>
          <option value="so2">SO‚ÇÇ</option>
          <option value="no2">NO‚ÇÇ</option>
        </select>
      </div>
      <div class="last-update" id="lastUpdate"></div>
    </div>
    <div id="map"></div>
    <div class="map-controls">
      <button onclick="zoomIn()">+</button>
      <button onclick="zoomOut()">-</button>
    </div>
    <div class="legend" id="legend"></div>
    <div class="chart-container">
      <canvas id="trendChart"></canvas>
    </div>
    <div class="loading" id="loading">Ë≥áÊñôÊõ¥Êñ∞‰∏≠...</div>

    <script>
      const apiKey = 'your-api-key';
      const apiUrl = `https://data.moenv.gov.tw/api/v2/aqx_p_488?limit=1000&api_key=${apiKey}`;
      let currentData = null;
      let trendChart = null;

      const map = L.map('map').setView([23.7, 121], 7);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap'
      }).addTo(map);

      let markerLayer = L.layerGroup().addTo(map);

      function zoomIn() {
        map.zoomIn();
      }

      function zoomOut() {
        map.zoomOut();
      }

      function updateLastUpdateTime() {
        const now = new Date();
        const timeString = now.toLocaleString('zh-TW', {
          year: 'numeric',
          month: '2-digit',
          day: '2-digit',
          hour: '2-digit',
          minute: '2-digit',
          second: '2-digit',
          hour12: false
        });
        document.getElementById('lastUpdate').innerText = `ÊúÄÂæåÊõ¥Êñ∞ÊôÇÈñìÔºö${timeString}`;
      }

      function toggleLoading(show) {
        document.getElementById('loading').style.display = show ? 'block' : 'none';
      }

      function updateLegend() {
        const pollutant = document.getElementById("pollutantSelect").value;
        const legend = document.getElementById("legend");
        legend.innerHTML = `
          <h4>${pollutant.toUpperCase()} ÊøÉÂ∫¶Á≠âÁ¥ö</h4>
          <div class="legend-item">
            <div class="legend-color" style="background-color: #2E8B57"></div>
            <span>0-12</span>
          </div>
          <div class="legend-item">
            <div class="legend-color" style="background-color: #9ACD32"></div>
            <span>13-35</span>
          </div>
          <div class="legend-item">
            <div class="legend-color" style="background-color: #FFD700"></div>
            <span>36-54</span>
          </div>
          <div class="legend-item">
            <div class="legend-color" style="background-color: #FFA500"></div>
            <span>55-150</span>
          </div>
          <div class="legend-item">
            <div class="legend-color" style="background-color: #FF4500"></div>
            <span>151-250</span>
          </div>
          <div class="legend-item">
            <div class="legend-color" style="background-color: #8B008B"></div>
            <span>251+</span>
          </div>
        `;
      }

      function updateTrendChart(data) {
        const ctx = document.getElementById('trendChart').getContext('2d');
        const pollutant = document.getElementById("pollutantSelect").value;
        
        if (trendChart) {
          trendChart.destroy();
        }

        const values = data.map(item => parseFloat(item[pollutant])).filter(v => !isNaN(v));
        const labels = data.map(item => item.sitename);

        trendChart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: labels,
            datasets: [{
              label: `${pollutant.toUpperCase()} ÊøÉÂ∫¶`,
              data: values,
              backgroundColor: values.map(v => getColor(v, pollutant)),
              borderColor: '#333',
              borderWidth: 1,
              borderRadius: 5,
              hoverBackgroundColor: values.map(v => getHoverColor(v, pollutant)),
              hoverBorderColor: '#000',
              hoverBorderWidth: 2
            }]
          },
          options: {
            responsive: true,
            animation: {
              duration: 1000,
              easing: 'easeInOutQuart'
            },
            scales: {
              y: {
                beginAtZero: true,
                title: {
                  display: true,
                  text: 'ÊøÉÂ∫¶ÂÄº',
                  font: {
                    size: 14,
                    weight: 'bold'
                  }
                },
                grid: {
                  color: 'rgba(0,0,0,0.1)'
                }
              },
              x: {
                title: {
                  display: true,
                  text: 'Ê∏¨Á´ô',
                  font: {
                    size: 14,
                    weight: 'bold'
                  }
                },
                grid: {
                  display: false
                }
              }
            },
            plugins: {
              tooltip: {
                backgroundColor: 'rgba(0,0,0,0.8)',
                titleFont: {
                  size: 14,
                  weight: 'bold'
                },
                bodyFont: {
                  size: 12
                },
                padding: 10,
                cornerRadius: 5
              },
              legend: {
                display: false
              }
            }
          }
        });
      }

      function getColor(value, pollutant) {
        const scale = [
          { max: 12, color: '#2E8B57' },
          { max: 35, color: '#9ACD32' },
          { max: 54, color: '#FFD700' },
          { max: 150, color: '#FFA500' },
          { max: 250, color: '#FF4500' },
          { max: Infinity, color: '#8B008B' }
        ];

        for (let i = 0; i < scale.length; i++) {
          if (value <= scale[i].max) return scale[i].color;
        }
        return '#000';
      }

      function getHoverColor(value, pollutant) {
        const scale = [
          { max: 12, color: '#3DA56D' },
          { max: 35, color: '#B0E57C' },
          { max: 54, color: '#FFE44D' },
          { max: 150, color: '#FFB74D' },
          { max: 250, color: '#FF6B4D' },
          { max: Infinity, color: '#A64DA6' }
        ];

        for (let i = 0; i < scale.length; i++) {
          if (value <= scale[i].max) return scale[i].color;
        }
        return '#333';
      }

      async function fetchData() {
        try {
          toggleLoading(true);
          const response = await fetch(apiUrl);
          if (!response.ok) throw new Error('API ÈåØË™§: ' + response.status);
          const json = await response.json();
          currentData = json.records;
          renderMarkers(currentData);
          updateTrendChart(currentData);
          updateLastUpdateTime();
          updateLegend();
        } catch (error) {
          console.error('Ë≥áÊñôÊì∑ÂèñÂ§±Êïó:', error);
          alert('Ë≥áÊñôÁÑ°Ê≥ïËºâÂÖ•ÔºåË´ãÊ™¢Êü• API ÈáëÈë∞ÊàñÁ∂≤Ë∑ØÈÄ£Á∑ö„ÄÇ');
        } finally {
          toggleLoading(false);
        }
      }

      function renderMarkers(data) {
        if (!data) return;
        
        markerLayer.clearLayers();
        const pollutant = document.getElementById("pollutantSelect").value;

        data.forEach((item) => {
          const lat = parseFloat(item.latitude);
          const lon = parseFloat(item.longitude);
          const value = parseFloat(item[pollutant]);
          if (!lat || !lon || isNaN(value)) return;

          const color = getColor(value, pollutant);
          const circle = L.circleMarker([lat, lon], {
            radius: 8,
            fillColor: color,
            color: '#333',
            weight: 1,
            fillOpacity: 0.8,
            className: 'marker-fade-in'
          }).addTo(markerLayer);

          const popupContent = `
            <strong>${item.sitename}Ôºà${item.county}Ôºâ</strong><br/>
            ${pollutant.toUpperCase()}Ôºö${value}<br/>
            ÁãÄÊÖãÔºö${item.status}<br/>
            ÊôÇÈñìÔºö${item.datacreationdate}
          `;
          circle.bindPopup(popupContent);
        });
      }

      // ÂàùÂßãÂåñ
      fetchData();
      
      // Ë®≠ÂÆöÊØèÂ∞èÊôÇËá™ÂãïÊõ¥Êñ∞
      setInterval(fetchData, 60 * 60 * 1000);

      // Áõ£ËÅΩÊ±°ÊüìÁâ©ÈÅ∏ÊìáËÆäÂåñ
      document.getElementById("pollutantSelect").addEventListener("change", () => {
        if (currentData) {
          renderMarkers(currentData);
          updateTrendChart(currentData);
          updateLegend();
        }
      });
    </script>
  </body>
</html>
