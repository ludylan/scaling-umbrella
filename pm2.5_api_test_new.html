
<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>台灣空氣品質地圖</title>
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <style>
      #map {
        height: 90vh;
        width: 100%;
      }
      body {
        font-family: sans-serif;
      }
      .info {
        padding: 6px;
        background: #f0f8ff;
        border-radius: 4px;
        margin: 10px;
      }
    </style>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  </head>
  <body>
    <h2>🌏 台灣空氣品質地圖</h2>
    <div class="info">
      顯示污染物：
      <select id="pollutantSelect">
        <option value="aqi">AQI</option>
        <option value="pm2_5">PM2.5</option>
        <option value="pm10">PM10</option>
        <option value="o3">O₃</option>
        <option value="co">CO</option>
        <option value="so2">SO₂</option>
        <option value="no2">NO₂</option>
      </select>
    </div>
    <div id="map"></div>

    <script>
      const apiKey = 'your-api-key'; // ← 請替換為你的 API 金鑰
      const apiUrl = `https://data.moenv.gov.tw/api/v2/aqx_p_488?limit=1000&api_key=${apiKey}`;

      const map = L.map('map').setView([23.7, 121], 7);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap'
      }).addTo(map);

      let markerLayer = L.layerGroup().addTo(map);

      fetch(apiUrl)
        .then((res) => res.json())
        .then((json) => {
          const records = json.records;
          renderMarkers(records);
          document.getElementById("pollutantSelect").addEventListener("change", () => renderMarkers(records));
        });

      function renderMarkers(data) {
        markerLayer.clearLayers();
        const pollutant = document.getElementById("pollutantSelect").value;

        data.forEach((item) => {
          const lat = parseFloat(item.latitude);
          const lon = parseFloat(item.longitude);
          const value = parseFloat(item[pollutant]);
          if (!lat || !lon || isNaN(value)) return;

          const color = getColor(value, pollutant);
          const circle = L.circleMarker([lat, lon], {
            radius: 8,
            fillColor: color,
            color: '#333',
            weight: 1,
            fillOpacity: 0.8,
          }).addTo(markerLayer);

          const popupContent = `
            <strong>${item.sitename}（${item.county}）</strong><br/>
            ${pollutant.toUpperCase()}：${value}<br/>
            狀態：${item.status}<br/>
            時間：${item.datacreationdate}
          `;
          circle.bindPopup(popupContent);
        });
      }

      function getColor(value, pollutant) {
        // 使用「大自然」色系：綠 → 黃 → 橘 → 紅 → 紫
        const scale = [
          { max: 12, color: '#2E8B57' },   // 深綠
          { max: 35, color: '#9ACD32' },   // 黃綠
          { max: 54, color: '#FFD700' },   // 金黃
          { max: 150, color: '#FFA500' },  // 橘
          { max: 250, color: '#FF4500' },  // 橘紅
          { max: Infinity, color: '#8B008B' } // 紫
        ];

        for (let i = 0; i < scale.length; i++) {
          if (value <= scale[i].max) return scale[i].color;
        }
        return '#000';
      }
    </script>
  </body>
</html>
